package org.opencds.cqf.cql.evaluator.builder.helpers;

import static org.junit.Assert.assertTrue;

import java.util.HashMap;
import java.util.Map;

import org.apache.commons.lang3.tuple.Pair;
import org.junit.Test;
import org.opencds.cqf.cql.evaluator.builder.helper.ModelVersionHelper;

public class ModelVersionHelperTests {
    @Test
    public void test_versionFromR4LibraryString() {
        Map<String, Pair<String, String>> models = new HashMap<String, Pair<String, String>>();
        String cql = "library RuleFilters version '1.0.0'\r\n\r\nusing FHIR version '4.0.0'\r\n\r\ninclude FHIRHelpers version '4.0.0'\r\n\r\ncodesystem \"UsageContext\": 'http://terminology.hl7.org/CodeSystem/usage-context-type'\r\nvalueset \"Indeterminate or Equivocal Lab Result Value\": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1146.1035'\r\nvalueset \"Negative or Undetected Lab Result Value\": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1146.1034'\r\n\r\ncode \"focus\": 'focus' from UsageContext\r\n//code \"Chlamydia\": 'Chlamydia'\r\n\r\nparameter \"Triggering Encounter\" Encounter\r\n\r\ncontext Patient\r\n\r\ndefine \"Chlamydia ValueSets\": [Patient]\r\n  //[ValueSet] ValueSet\r\n    /* where exists (\r\n      ValueSet.useContext UseContext\r\n        where UseContext.code ~ \"focus\"\r\n          and not  IsNull(\r\n            UseContext.value Value\r\n              where Value.text = 'Chlamydia'\r\n          )\r\n    ) */\r\n\r\n/* define function ExpandValueSetCodes(value List<ValueSet>):\r\n  value Value\r\n    return Value.expansion.contains.code\r\n\r\ndefine function ExpandValueSetSystems(value List<ValueSet>):\r\n  value Value\r\n    return Value.expansion.contains.system\r\n\r\ndefine \"Flattened ValueSet Expansion Codes\":\r\n  flatten( ExpandValueSetCodes(\"Chlamydia ValueSets\") )\r\n\r\ndefine \"Flattened ValueSet Expansion Systems\":\r\n  flatten( ExpandValueSetSystems(\"Chlamydia ValueSets\") )\r\n\r\ndefine function ObservationWithSystemAndCodeInChlamydiaValueSets(observation Observation):\r\n    not IsNull(\r\n      observation.code  OConcept\r\n        where exists (\r\n          OConcept.coding OCoding\r\n            where ( OCoding.code in \"Flattened ValueSet Expansion Codes\" )\r\n               and OCoding.system in \"Flattened ValueSet Expansion Systems\"\r\n        )\r\n    )\r\n\r\ndefine function ObservationWithCodeInChlamydiaValueSets(observation Observation):\r\n  not IsNull(\r\n    observation.code  OConcept\r\n      where exists (\r\n        OConcept.coding OCoding where OCoding.code in flatten( ExpandValueSetCodes(\"Chlamydia ValueSets\") )\r\n      )\r\n  )\r\n\r\ndefine function ChlamydiaObservations(observation Observation):\r\n  if exists (observation.code.coding.system)\r\n  then ObservationWithSystemAndCodeInChlamydiaValueSets(observation)\r\n  else ObservationWithCodeInChlamydiaValueSets(observation)\r\n\r\ndefine \"Chlamydia Test Results\":\r\n  [Observation] O\r\n    where ChlamydiaObservations(O)\r\n      and O.status in { 'preliminary', 'final', 'amended', 'corrected' }\r\n\r\ndefine \"Encounter Location References\":\r\n  \"Triggering Encounter\" TriggeringEncounter\r\n    return TriggeringEncounter.location.location\r\n\r\ndefine \"Locations Matching Encounter Location References\":\r\n  [Location] Location\r\n    where exists (\r\n        \"Encounter Location References\" LocationReference\r\n          where Location.id ~ LocationReference.reference\r\n      )\r\n\r\ndefine \"Encounter Location Addresses And Patient Addresses\":\r\n  \"Locations Matching Encounter Location References\".address\r\n    union Patient.address\r\n\r\ndefine \"Address Elements Relevant to Jurisdiction Qualification\":\r\n  \"Encounter Location Addresses And Patient Addresses\" Address\r\n    return Tuple { state: Address.state,  postalCode: Address.postalCode }\r\n\r\ndefine \"Jurisdiction Codes\":\r\n  { 'UT', 'GA', 'CA', '84054', '84118', '30302' }\r\n\r\ndefine \"Address is in Jurisdiction Codes\":\r\n  exists (\r\n    \"Address Elements Relevant to Jurisdiction Qualification\" AddressElement\r\n      where AddressElement.state in \"Jurisdiction Codes\"\r\n        or AddressElement.postalCode in \"Jurisdiction Codes\"\r\n  )\r\n\r\ndefine \"Indeterminate Chlamydia Test Results\":\r\n  \"Chlamydia Test Results\" O\r\n    let organization: [Organization]\r\n    where (\r\n      (\r\n        exists (\r\n            O.interpretation interpretationConcept\r\n              where interpretationConcept as CodeableConcept in \"Indeterminate or Equivocal Lab Result Value\"\r\n        )\r\n          or O.value as CodeableConcept in \"Indeterminate or Equivocal Lab Result Value\"\r\n      )\r\n        and \"Address is in Jurisdiction Codes\"\r\n    )\r\n\r\ndefine \"Negative Chlamydia Test Results\":\r\n  \"Chlamydia Test Results\" O\r\n    let organization: [Organization]\r\n    where (\r\n      (\r\n        exists (\r\n            O.interpretation interpretationConcept\r\n              where interpretationConcept as CodeableConcept in \"Negative or Undetected Lab Result Value\"\r\n        )\r\n          or O.value as CodeableConcept in \"Negative or Undetected Lab Result Value\"\r\n      )\r\n        and \"Address is in Jurisdiction Codes\"\r\n    ) */\r\n\r\ndefine \"IsReportable\": exists (\"Chlamydia ValueSets\")\r\n  /* exists \"Indeterminate Chlamydia Test Results\"\r\n    or exists \"Negative Chlamydia Test Results\" */\r\n";
        ModelVersionHelper.setModelVersionFromLibraryString(models, cql);
        String model = "http://hl7.org/fhir";
        String version = "4.0.0";
        // assertTrue(String.format("Model Map URIs did not match %s:%s", models.get(model).getLeft(), version), models.get(model).getLeft().matches(version));
        assertTrue(String.format("Model Map URIs did not match %s:%s", models.get(model).getRight(), "null"), models.get(model).getRight() == null);
    }
}